# functional-spec.md（機能仕様 / LLM GM ソロTRPG）

## 0. 目的
本書は「ゲーム全体の機能」「LLM連携の責務分界」「状態管理（実装寄り）」「最低限の運用方針」をまとめて定義する。  
数値ルールは `mechanics-spec.md`、ゲーム体験の骨格は `game-spec.md`、UI詳細は `ui-spec.md` を参照する。

---

## 1. 機能一覧（MVP）
### 1.1 セッション
- 新規セッション開始
- セッション終了（成功/失敗/時間切れ）とリザルト生成
- セッション中断（保存/再開は **なし**。ブラウザ再読み込み等は「中断＝終了」扱い）

### 1.2 キャラクター作成（PC作成）
- プロフィール入力（名前/年齢/性別/職業/特徴など）
- 能力値生成（ダイス）と確定
- 派生値の算出と確定
- 技能ポイント算出、技能割り振り、技能確定  
  - 具体ルールは `mechanics-spec.md`

### 1.3 シナリオ生成（毎回新規）
- プレイ開始時にLLMへ「初期シナリオ生成（全体像＋導入）」を依頼
- セッション進行中は「次シーン生成/進行」を逐次依頼
- シナリオテンプレは持たず、毎回LLMが新規生成する

### 1.4 チャット進行
- GM（LLM）メッセージの表示
- プレイヤー入力（自由入力）
- GMが提示する選択肢の表示（任意）
- 判定が必要な場合の判定フロー（2章）

### 1.5 状態表示
- PCステータス（能力値/派生値/技能の概要、主要リソース）
- 所持品
- 目的（直近の目標）
- 重要フラグ（取得した手掛かり/進行状況）
- ログ（チャット履歴）

### 1.6 ログ/要約
- チャットログを保持（セッション中のみ）
- LLMに渡すための「要約（サマリ）」をセッション中に更新

---

## 2. 判定フロー（機能としての扱い）
> 数値計算や成功段階は `mechanics-spec.md` に準拠する。ここでは「誰が何を入力し、どの順で進むか」を定義する。

### 2.1 判定要求
- GM（LLM）は判定が必要なとき、必ず以下を明示する：
  - 使用する技能（例：目星）
  - 難易度（標準/難しい 等。補正はアプリ側で反映）
  - 判定の目的（何を達成したいか）
  - 失敗時に起こり得る代償の方向性（例：時間消費、危険度上昇）

### 2.2 ロール主体
- **ロール（d100）はプレイヤーが振る**（アプリが乱数生成して提示する）
  - 乱数はクライアント生成でもよい（趣味開発のため）
  - 出目はログに記録される

### 2.3 判定処理
- アプリは以下を自動で計算する：
  - 目標値（技能値＋難易度補正）
  - 成功/失敗、成功段階（ハード/イクストリーム等）
- 判定結果（出目、目標値、成功段階）をGM（LLM）へ渡す

### 2.4 判定結果の語り（LLMの役割）
- GM（LLM）は判定結果に基づき、物語的結果を生成する
- 失敗時は `mechanics-spec.md` の「代償」を用いて **進行不能にしない** 形で前進させる

---

## 3. 状態管理（LLM連携の責務分界）
### 3.1 状態の正
- **状態の正（source of truth）はアプリ側**とする
- LLMは状態を「提案」するが、最終反映はアプリが行う

### 3.2 状態オブジェクト（概念）
アプリはセッション状態を、概ね以下で保持する（JSON相当）。
- session
  - session_id
  - scene_index
  - phase（導入/中盤/終盤/終幕 など）
  - summary（要約テキスト）
  - outline（全体像：非公開。毎回LLMに渡す前提ではない）
  - guidance（全体像の短縮：必要時のみLLMに渡す）
- pc
  - profile（名前等）
  - abilities（STR等）
  - derived（SAN/HP/MP等）
  - skills（技能一覧）
  - resources（mechanicsで採用しているもの）
  - inventory（所持品）
- world
  - objective（直近目的）
  - flags（重要フラグ）
  - npcs（必要なら簡易：名前/関係/状態）
- log
  - messages（チャット履歴、判定履歴）

### 3.3 LLMへの入力（通常）
通常のターンで、アプリがLLMに渡す情報は以下を最小セットとする。
- 直近のチャット（N件）
- 現在の要約（summary）
- 現在の状態（objective、inventory、主要リソース、重要フラグ）
- プレイヤー入力（テキスト）
- （判定後の場合）判定結果（技能、目標値、出目、成功段階）

※`outline`（全体像）は原則渡さない。

### 3.4 LLMへの入力（節目・例外）
次のタイミングでは、アプリは `guidance`（短縮版の全体像）を併せて渡してよい。
- シーン切替時
- 中盤→終盤への移行時（収束を強めたいとき）
- ループ/迷子の兆候があるとき（同じ状況が繰り返される、objectiveが曖昧等）
- 終幕直前（結末条件の取りこぼし防止）

`guidance` は短く保つ（目安：5〜10行）。
- 真相（1行）
- 主な対立/障害（1〜2行）
- 回収すべき鍵（1〜2行）
- 結末条件（1〜2行）
- 収束方針（1行）

### 3.5 LLMからの出力（契約）
LLMは以下を返す（構造化＋本文の併用を推奨）。
- player_facing_text：プレイヤーに表示するGM文
- choices（任意）：2〜4個の選択肢（短文）
- check_request（任意）：技能名＋難易度＋目的（判定が必要なときのみ）
- state_patch（任意）：状態更新の提案（例：resources変化、flags追加、inventory変更、objective更新）
- end_signal（任意）：セッション終了提案（success/fail/time_up等）

### 3.6 状態更新の反映ルール
- アプリは `state_patch` をそのまま適用せず、最低限以下を検証する：
  - リソースが範囲外にならない（上限/下限は `mechanics-spec.md`）
  - 同じフラグの重複追加をしない
  - inventory枠上限を超えない（上限は `mechanics-spec.md` またはUI方針）
- 反映後の状態は次ターン入力に利用する

---

## 4. シナリオ生成・進行仕様（機能）
### 4.1 初期シナリオ生成（開始時）
PC確定後、アプリはLLMへ「初期生成」を依頼する。LLMは以下を返す。

（入力：アプリ→LLM）
- PC情報（プロフィール、能力値/技能の要約）
- ユーザー指定のテーマ・雰囲気（自然言語、任意）
- 1時間完結の制約（シーン上限、分岐上限、終幕へ収束させること）
- mechanicsの前提（d100判定、成功段階、代償で前進）

（出力：LLM→アプリ）
- outline（全体像）
- guidance（短縮版の全体像：任意。アプリ側生成でもよい）
- 導入シーン（状況、フック、直近目的 objective）
- 初期フラグ（空でもよい）
- 必要なら初期所持品の提案（アプリが採否決定）

アプリは `outline` を保持し、そこから `guidance`（短縮版）を生成して保持してよい。

### 4.2 シーン進行（毎ターン）
- プレイヤー入力を受け、アプリはLLMへ進行を依頼する
- LLMは以下を満たす：
  - 次にすべきこと（objective）を曖昧にしない
  - 選択肢を出す場合は少数（2〜4）に絞る
  - 判定が必要な場合は check_request を返す

### 4.3 収束（1時間で終わらせる）
- アプリは `scene_index` を進め、終盤に入ったらLLMへ「終幕へ寄せる」指示を強める
- 次のいずれかで終幕へ強制移行してよい：
  - シーン数上限に到達
  - TIME等（採用している場合）が0
  - GMが end_signal を返す（大局的に収束すべきと判断した場合）

---

## 5. 要約（サマリ）更新仕様
- アプリは一定間隔で要約を更新する（例：シーン切替時、またはログがN件増えたとき）
- 要約に含めるべき内容：
  - 現在の目的
  - 得た重要情報/フラグ
  - NPC関係の変化（必要な場合）
  - 主要リソースの現在値
  - 直近の出来事（短文）

※要約生成もLLMに依頼してよいが、要約結果はアプリ側が保持する。

---

## 6. ログ方針（セーブなし前提）
- チャットログは **セッション中のみ保持**し、保存/再開は行わない
- ブラウザ更新やタブ終了などで状態が失われた場合、セッションは終了扱いとする
- （任意）セッション終了時に、テキストとしてログをコピー/ダウンロードできる導線を用意してよい（UI詳細は `ui-spec.md`）

---

## 7. 終了処理（リザルト）
### 7.1 終了条件
`game-spec.md` の方針に従い、成功/失敗/時間切れのいずれかで終了する。

### 7.2 リザルト生成
- アプリはLLMへ「リザルト文章生成」を依頼してよい
- リザルトには最低限以下を含める：
  - 結末種別
  - 重要な出来事の要約
  - 獲得物/失ったもの
  - 最終状態（主要リソース/重要フラグ）

---

## 8. エラーと例外（最低限）
- LLM応答が不正（JSON欠落等）の場合：
  - 1回だけリトライしてよい
  - それでも失敗したら、プレイヤーに「続行不可」表示してセッション終了扱い
- 判定要求が曖昧な場合：
  - アプリ側でプレイヤーに再入力を促す（技能/難易度が特定できない等）

---

## 9. 仕様間の参照
- ゲーム体験の骨格：`game-spec.md`
- 数値ルール：`mechanics-spec.md`
- UI：`ui-spec.md`